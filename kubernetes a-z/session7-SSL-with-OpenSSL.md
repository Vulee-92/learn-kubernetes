# Ph·∫ßn 7 - H∆∞·ªõng d·∫´n t·∫°o t√≠ch xanh cho ·ª©ng d·ª•ng tr√™n K8S d√πng OpenSSL

**L·ªùi t·ª±a**

Ch√†o c√°c b·∫°n, h√¥m nay m√¨nh s·∫Ω chia s·∫ª c√°ch ƒë·ªÉ t·∫°o "t√≠ch xanh" cho ·ª©ng d·ª•ng ch·∫°y tr√™n K8S ·ªü local üòÑ. Th√¨ nhi·ªÅu b·∫°n s·∫Ω th·∫Øc m·∫Øc "t√≠ch xanh" l√† g√¨? C√¢u tr·∫£ l·ªùi ƒë√≥ l√† app c·ªßa b·∫°n c√≥ s·ª≠ d·ª•ng Ch·ª©ng th∆∞ s·ªë SSL (SSL Certification)

SSL l√† vi·∫øt t·∫Øt c·ªßa t·ª´ Secure Sockets Layer. SSL l√† ti√™u chu·∫©n c·ªßa c√¥ng ngh·ªá b·∫£o m·∫≠t, truy·ªÅn th√¥ng m√£ ho√° gi·ªØa m√°y ch·ªß Web server v√† tr√¨nh duy·ªát nh·∫±m ƒë·∫£m b·∫£o t√≠nh ri√™ng t∆∞ v√† to√†n v·∫πn d·ªØ li·ªáu khi truy·ªÅn gi·ªØa c√°c m√°y ch·ªß Web v√† c√°c tr√¨nh duy·ªát ·ªü client. SSL hi·ªán t·∫°i c≈©ng l√† ti√™u chu·∫©n b·∫£o m·∫≠t cho h√†ng tri·ªáu website tr√™n to√†n th·∫ø gi·ªõi, n√≥ b·∫£o v·ªá d·ªØ li·ªáu truy·ªÅn ƒëi tr√™n m√¥i tr∆∞·ªùng internet ƒë∆∞·ª£c an to√†n.

Ch·ª©ng th∆∞ s√¥ÃÅ SSL c√†i tr√™n website c·ªßa doanh nghi·ªáp cho ph√©p kh√°ch h√†ng khi truy c·∫≠p c√≥ th·ªÉ x√°c minh ƒë∆∞·ª£c t√≠nh x√°c th·ª±c, tin c·∫≠y c·ªßa website, ƒë·∫£m b·∫£o m·ªçi d·ªØ li·ªáu, th√¥ng tin trao ƒë·ªïi gi·ªØa website v√† kh√°ch h√†ng ƒë∆∞·ª£c m√£ h√≥a, tr√°nh nguy c∆° b·ªã can thi·ªáp.

**M·ªôt s·ªë kh√°i ni·ªám v·ªÅ SSL**

**Certificate Authority (CA)**

CA l√† t·ªï ch·ª©c ph√°t h√†nh c√°c ch·ª©ng th·ª±c c√°c lo·∫°i ch·ª©ng th∆∞ s√¥ÃÅ (Certificate) cho ng∆∞·ªùi d√πng, doanh nghi·ªáp, m√°y ch·ªß (server), m√£ code, ph√¢ÃÄn m√™ÃÄm. Nh√† cung c·∫•p ch·ª©ng th·ª±c s·ªë ƒë√≥ng vai tr√≤ l√† b√™n th·ª© ba (ƒë∆∞·ª£c c·∫£ hai b√™n tin t∆∞·ªüng) ƒë·ªÉ h·ªó tr·ª£ cho qu√° tr√¨nh trao ƒë·ªïi th√¥ng tin an to√†n. V√≠ d·ª• m·ªôt s·ªë nh√† cung c·∫•p ch·ª©ng th∆∞ ph·ªï bi·∫øn nh∆∞ Global Sign, VeriSign, DigiCert..

**Domain Validation (DV SSL)**

Ch·ª©ng th∆∞ s·ªë SSL ch·ª©ng th·ª±c cho Domain Name ‚Äì Website. Khi 1 Website s·ª≠ d·ª•ng DV SSL th√¨ s·∫Ω ƒë∆∞·ª£c x√°c th·ª±c t√™n domain, website ƒë√£ ƒë∆∞·ª£c m√£ ho√° an to√†n khi trao ƒë·ªïi d·ªØ li·ªáu.

**Organization Validation (OV SSL)**

Ch·ª©ng th∆∞ s·ªë SSL ch·ª©ng th·ª±c cho Website v√† x√°c th·ª±c doanh nghi·ªáp ƒëang s·ªü h·ªØu website ƒë√≥ .

**Extended Validation (EV SSL)**

Cho kh√°ch h√†ng c·ªßa b·∫°n th·∫•y Website ƒëang s·ª≠ d·ª•ng ch·ª©ng th∆∞ SSL c√≥ ƒë·ªô b·∫£o m·∫≠t cao nh·∫•t v√† ƒë∆∞·ª£c r√† so√°t ph√°p l√Ω k·ªπ c√†ng.

**Subject Alternative Names (SANs SSL)**

Nhi·ªÅu t√™n mi·ªÅn h·ª£p nh·∫•t trong 1 ch·ª©ng th∆∞ s·ªë:

M·ªôt ch·ª©ng th∆∞ s·ªë SSL ti√™u chu·∫©n ch·ªâ b·∫£o m·∫≠t cho duy nh·∫•t m·ªôt t√™n mi·ªÅn ƒë√£ ƒë∆∞·ª£c ki·ªÉm ƒë·ªãnh. L·ª±a ch·ªçn th√™m SANs ch·ªâ v·ªõi ch·ª©ng th∆∞ duy nh·∫•t b·∫£o ƒë·∫£m cho nhi·ªÅu t√™n mi·ªÅn con. SANs mang l·∫°i s·ª± linh ho·∫°t cho ng∆∞·ªùi s·ª≠ d·ª•ng, d·ªÖ d√†ng h∆°n trong vi·ªác c√†i ƒë·∫∑t, s·ª≠ d·ª•ng v√† qu·∫£n l√Ω ch·ª©ng th∆∞ s·ªë SSL.

Ch·ª©ng th∆∞ s·ªë SSL SANs c√≥ th·ªÉ t√≠ch h·ª£p v·ªõi t·∫•t c·∫£ c√°c lo·∫°i ch·ª©ng th∆∞ s·ªë SSL c·ªßa GlobalSign bao g·ªìm: Ch·ª©ng th·ª±c t√™n mi·ªÅn (DV SSL), Ch·ª©ng th·ª±c t·ªï ch·ª©c doanh nghi·ªáp (OV SSL) v√† Ch·ª©ng th·ª±c m·ªü r·ªông cao c·∫•p (EV SSL).

**Wildcard SSL Certificate (Wildcard SSL)**

S·∫£n ph·∫©m l√Ω t∆∞·ªüng d√†nh cho c√°c c·ªïng th∆∞∆°ng m·∫°i ƒëi·ªán t·ª≠. M·ªói e-store l√† m·ªôt sub-domain v√† ƒë∆∞·ª£c chia s·∫ª tr√™n m·ªôt ho·∫∑c nhi·ªÅu ƒë·ªãa ch·ªâ IP. Khi ƒë√≥, ƒë·ªÉ tri·ªÉn khai gi·∫£i ph√°p b·∫£o b·∫£o m·∫≠t giao d·ªãch tr·ª±c tuy·∫øn (ƒë·∫∑t h√†ng, thanh to√°n, ƒëƒÉng k√Ω & ƒëƒÉng nh·∫≠p t√†i kho·∫£n,‚Ä¶) b·∫±ng SSL, ch√∫ng ta c√≥ th·ªÉ d√πng duy nh·∫•t m·ªôt ch·ª©ng ch·ªâ s·ªë Wildcard cho t√™n mi·ªÅn ch√≠nh c·ªßa website v√† t·∫•t c·∫£ sub-domain.

**Ki·ªÉm tra t√≠nh x√°c th·ª±c c·ªßa SSL**

Khi Website g·ªüi cho tr√¨nh duy·ªát m·ªôt ch·ª©ng ch·ªâ SSL, Tr√¨nh duy·ªát s·∫Ω g·ªüi ch·ª©ng ch·ªâ n√†y ƒë·∫øn m·ªôt m√°y ch·ªß l∆∞u tr·ªØ c√°c ch·ª©ng ch·ªâ s·ªë ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát. C√°c m√°y ch·ªß n√†y ƒë∆∞·ª£c th√†nh l·∫≠p b·ªüi nh·ªØng c√¥ng ty uy t√≠n nh∆∞ GlobalSign, VeriSign.

V·ªÅ m·∫∑t k·ªπ thu·∫≠t, SSL s·ª≠ d·ª•ng m√£ h√≥a c√¥ng khai. K·ªπ thu·∫≠t n√†y gi√∫p cho Website v√† Tr√¨nh duy·ªát t·ª± th·ªèa thu·∫≠n m·ªôt b·ªô kh√≥a s·∫Ω d√πng trong su·ªët qu√° tr√¨nh trao ƒë·ªïi th√¥ng tin sau ƒë√≥.

B·ªô kh√≥a s·∫Ω thay ƒë·ªïi theo m·ªói trong l·∫ßn giao d·ªãch k·∫ø ti·∫øp, m·ªôt ng∆∞·ªùi kh√°c s·∫Ω kh√¥ng th·ªÉ gi·∫£i m√£ ngay c·∫£ khi c√≥ ƒë∆∞·ª£c d·ªØ li·ªáu c·ªßa m√°y ch·ªß l∆∞u tr·ªØ ch·ª©ng ch·ªâ s·ªë n√≥i tr√™n.

**C∆° ch·∫ø ho·∫°t ƒë·ªông khi s·ª≠ d·ª•ng SSL**

![alt text](image-27.png)

**L·ª£i √≠ch khi s·ª≠ d·ª•ng SSL**

X√°c th·ª±c website, giao d·ªãch.

N√¢ng cao h√¨nh ·∫£nh, th∆∞∆°ng hi·ªáu v√† uy t√≠n doanh nghi·ªáp.

B·∫£o m·∫≠t c√°c giao d·ªãch gi·ªØa kh√°ch h√†ng v√† doanh nghi·ªáp, c√°c d·ªãch v·ª• truy nh·∫≠p h·ªá th·ªëng.

B·∫£o m·∫≠t webmail v√† c√°c ·ª©ng d·ª•ng nh∆∞ Outlook Web Access, Exchange, v√† Office Communication Server.

B·∫£o m·∫≠t c√°c ·ª©ng d·ª•ng ·∫£o h√≥ nh∆∞ Citrix Delivery Platform ho·∫∑c c√°c ·ª©ng d·ª•ng ƒëi·ªán to√°n ƒë√°m m√¢y.

B·∫£o m·∫≠t d·ªãch v·ª• FTP.

B·∫£o m·∫≠t truy c·∫≠p control panel.

B·∫£o m·∫≠t c√°c d·ªãch v·ª• truy·ªÅn d·ªØ li·ªáu trong m·∫°ng n·ªôi b·ªô, file sharing, extranet.

B·∫£o m·∫≠t VPN Access Servers, Citrix Access Gateway ‚Ä¶

Website kh√¥ng ƒë∆∞·ª£c x√°c th·ª±c v√† b·∫£o m·∫≠t s·∫Ω lu√¥n ·∫©n ch·ª©a nguy c∆° b·ªã x√¢m nh·∫≠p d·ªØ li·ªáu, d·∫´n ƒë·∫øn h·∫≠u qu·∫£ kh√°ch h√†ng kh√¥ng tin t∆∞·ªüng s·ª≠ d·ª•ng d·ªãch v·ª•.

**M·ªôt l·ª£i √≠ch l·ªõn kh√°c n·ªØa khi b·∫°n c·∫•u h√¨nh SSL cho c√°c app ·ªü local c·ªßa b·∫°n th√¨ nh√¨n n√≥ s·∫Ω PRO h∆°n, ƒë·∫πp m·∫Øt h∆°n!!**

# SSL Termination

Trong m√¥ h√¨nh Load Balancing, HAProxy ƒë·ª©ng gi·ªØa client v√† c√°c backend servers, v√¨ v·∫≠y k·∫øt n·ªëi m√£ h√≥a SSL gi·ªØa client v√† server s·∫Ω c√≥ th·ªÉ ƒë∆∞·ª£c th·ª±c hi·ªán theo c√°c c√°ch th·ª©c sau:

Th·ª±c hi·ªán y√™u c·∫ßu k·∫øt n·ªëi m√£ h√≥a SSL gi·ªØa Client v√† HAProxy, c√≤n t·ª´ HAProxy th·ª±c hi·ªán c√°c k·∫øt n·ªëi kh√¥ng m√£ h√≥a v·ªõi backend servers. Ph∆∞∆°ng th·ª©c n√†y g·ªçi l√† SSL Termination --> Gi√∫p gi·∫£m m·ª©c ƒë·ªô m·ª©c ph·ª©c t·∫°p khi ch·ªâ ph·∫£i qu·∫£n l√Ω SSL Certificate ·ªü node Haproxy, v√† gi·∫£m t·∫£i CPU cho c√°c webserver khi vi·ªác m√£ h√≥a/gi·∫£i m√£ ƒë∆∞·ª£c th·ª±c hi·ªán ·ªü Haproxy

![alt text](image-28.png)

Th·ª±c hi·ªán y√™u c·∫ßu k·∫øt n·ªëi tr·ª±c ti·∫øp gi·ªØa Client v√† c√°c backend servers. Tuy nhi√™n, khi ƒë√≥ ch√∫ng ta l·∫°i kh√¥ng th·ªÉ th·ª±c hi·ªán Add/Set ph·∫ßn Header. Ph∆∞∆°ng th·ª©c n√†y g·ªçi l√† SSL Passthrough

**H∆∞·ªõng d·∫´n t·ª± t·∫°o self-signed certificate ƒë·ªÉ ch·∫°y tr√™n local (t·∫°o t√≠ch xanh üòÑ)**

**T·∫°o Certificate Authority**

Th√¥ng th∆∞·ªùng ƒë·ªÉ c√≥ Cert "X·ªãn", h√†ng Auth th√¨ b·∫°n ph·∫£i mua c·ªßa c√°c nh√† cung c·∫•p ch·ª©ng th∆∞ (g·ªçi l√† CA). Nh∆∞ng ta c√≥ th·ªÉ t·ª± t·∫°o m·ªôt CA ·ªü tr√™n Local v√† nh·∫≠p v√†o tr√¨nh duy·ªát ƒë·ªÉ tr√¨nh duy·ªát hi·ªÉu l√† CA (m√† ch√∫ng ta t·∫°o ra) l√† m·ªôt nh√† cung c·∫•p CA tin c·∫≠y. Sau ƒë√≥, c√°c ch·ª©ng ch·ªâ ƒë∆∞·ª£c c·∫•p b·ªüi CA n√†y s·∫Ω ƒë∆∞·ª£c coi l√† h·ª£p l·ªá.

**T·∫°o private key cho CA:**

```
openssl genrsa -des3 -out rootCA.key 2048
Enter pass phrase for rootCA.key:
Verifying - Enter pass phrase for rootCA.key:
```

Nh·∫≠p th√¥ng tin pass phrase cho rootCA.key, c√°i n√†y do b·∫°n t·ª± ƒë·∫∑t nh√©!

**T·∫°o file pem t·ª´ file private key (nh·∫≠p pass c·ªßa rootCA ƒë√£ t·∫°o b√™n tr√™n)**

```
[root@viettq-master1 ssl2]# openssl req -x509 -new -nodes -key rootCA.key -sha256 -days 1825 -out rootCA.pem
Enter pass phrase for rootCA.key:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:VN
State or Province Name (full name) []:HN
Locality Name (eg, city) [Default City]:HN
Organization Name (eg, company) [Default Company Ltd]:VietTQ_CA
Organizational Unit Name (eg, section) []:VietTQ_CA_Unit
Common Name (eg, your name or your server's hostname) []:*.viettq.com
Email Address []:viettq@email.com
```

Sau b∆∞·ªõc n√†y m√¨nh s·∫Ω c√≥ 2 file .key v√† .pem cho rootCA:

```
[root@master1 ssl2]# ls -lrt
total 8
-rw-r--r-- 1 root root 1751 Apr 16 04:27 rootCA.key
-rw-r--r-- 1 root root 1424 Apr 16 04:29 rootCA.pem
```

**Nh·∫≠p th√¥ng tin CA v·ª´a t·∫°o cho tr√¨nh duy·ªát (client)**

**ƒê·ªëi v·ªõi tr√¨nh duy·ªát chrome**

Sau ƒë√≥ m·ªü Chrome v√† v√†o ƒë·ªãa ch·ªâ n√†y ƒë·ªÉ v√†o m·ª•c setting: chrome://settings/security --> Ch·ªçn v√†o Manage certificates Trong h·ªôp tho·∫°i hi·ªán ra b·∫°n v√†o tab **Trusted Root Certification Authorities** --> Import --> Next --> Browse --> Ch·ªçn file rootCA.pem --> Next --> Next --> Finish.

![alt text](image-29.png)

Khi h·ªôp tho·∫°i Security Warning hi·ªán l√™n b·∫°n ch·ªçn v√†o Yes, sau ƒë√≥ close h·ªôp tho·∫°i v√† l√∫c n√†o th√¥ng tin CA ƒë√£ ƒë∆∞·ª£c import v√†o Chrome.

![alt text](image-30.png)

**T·∫°o SSL Certificate cho ·ª©ng d·ª•ng web ·ªü local**

ƒê·∫ßu ti√™n ta t·∫°o m·ªôt file openssl.cnf ƒë·ªÉ c·∫•u h√¨nh th√™m th√¥ng tin SAN nh∆∞ sau:

```
[req]
distinguished_name = req_distinguished_name
req_extensions = v3_req
[req_distinguished_name]
countryName = VN
countryName_default = VN
stateOrProvinceName = HN
stateOrProvinceName_default = HN
localityName = HN
localityName_default = HN
organizationalUnitName = VietTQ_DEVOPS
organizationalUnitName_default = VietTQ_DEVOPS
commonName = *.viettq.com
commonName_max = 64
[ v3_req ]
# Extensions to add to a certificate request
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
subjectAltName = @alt_names
[alt_names]
DNS.1 = *.monitor.viettq.com
DNS.2 = *.prod.viettq.com
DNS.3 = *.demo.viettq.com
```

·ªû ƒë√¢y m√¨nh s·∫Ω t·∫°o SSL Certcificate cho c√°c app c·ªßa m√¨nh s·ª≠ d·ª•ng 3 subdomain l√† *.monitor.viettq.com, *.prod.viettq.com v√† *.demo.viettq.com

Ti·∫øp theo ta t·∫°o file key:

```
sudo openssl genrsa -out viettq_app.key 2048
```

Sau ƒë√≥ ta t·∫°o file Sigining Request t·ª´ file key v√† file config tr√™n:

```
sudo openssl req -new -out viettq_app.csr -key viettq_app.key -config openssl.cnf
```

Sau ƒë√≥ ta t·∫°o file Sigining Request t·ª´ file key v√† file config tr√™n:

```
sudo openssl req -new -out viettq_app.csr -key viettq_app.key -config openssl.cnf
```

K·∫øt qu·∫£ sinh ra file **viettq_app.csr**

```
[root@master1 ssl2]# ls -lrt
total 20
-rw-r--r-- 1 root root 1751 Apr 16 04:27 rootCA.key
-rw-r--r-- 1 root root 1424 Apr 16 04:29 rootCA.pem
-rw-r--r-- 1 root root 1679 Apr 16 04:58 viettq_app.key
-rw-r--r-- 1 root root  641 Apr 16 04:59 openssl.cnf
-rw-r--r-- 1 root root 1131 Apr 16 04:59 viettq_app.csr
```

R·ªìi t·ªõi b∆∞·ªõc quan tr·ªçng nh·∫•t l√† mang ƒë∆°n ƒëi ƒë√≥ng d·∫•u üòÑ. File .csr (Certificate Siging Request) gi·ªëng nh∆∞ t·ªù ƒë∆°n xin x√°c nh·∫≠n c·ªßa b·∫°n, ph·∫£i b·∫°n c·∫ßn mang ƒëi xin √¥ng CA ƒë√≥ng d·∫•u cho. V√† v√¨ m√¨nh ƒë√£ t·ª± ƒë√≥ng vai tr√≤ CA (v·ªõi 2 file .key v√† .pem ƒë√£ t·∫°o ·ªü b∆∞·ªõc tr∆∞·ªõc) th√¨ m√¨nh s·∫Ω t·ª± ƒë√≥ng d·∫•u cho y√™u c·∫ßu n√†y:

```
[root@master1 ssl]# sudo openssl x509 -req -days 3650 -in viettq_app.csr -CA rootCA.pem -CAkey rootCA.key -CAcreateserial -out viettq_app.crt -extensions v3_req -extfile openssl.cnf
Signature ok
subject=/C=VN/ST=HN/L=HN/OU=VietTQ_DEVOPS/CN=*.viettq.com
Getting CA Private Key
Enter pass phrase for rootCA.key:
[root@master1 ssl]# ls -lrt
total 28
-rw-r--r-- 1 root root 1751 Apr 16 04:27 rootCA.key
-rw-r--r-- 1 root root 1424 Apr 16 04:29 rootCA.pem
-rw-r--r-- 1 root root 1679 Apr 16 04:58 viettq_app.key
-rw-r--r-- 1 root root  641 Apr 16 04:59 openssl.cnf
-rw-r--r-- 1 root root 1131 Apr 16 04:59 viettq_app.csr
-rw-r--r-- 1 root root   17 Apr 16 05:02 rootCA.srl
-rw-r--r-- 1 root root 1371 Apr 16 05:02 viettq_app.crt
```

K·∫øt qu·∫£ s·∫Ω sinh ra file viettq_app.crt. B√¢y gi·ªù ta s·∫Ω t·∫°o file viettq_app.pem t·ª´ 3 file viettq_app.key, viettq_app.csr v√† viettq_app.crt:

```
cat viettq_app.key > server.pem
cat viettq_app.csr >> server.pem
cat viettq_app.crt >> server.pem
```